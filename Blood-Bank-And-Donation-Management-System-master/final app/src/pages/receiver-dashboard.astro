---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<Layout>
	<Header currentPage="receiver" />
	
	<main class="dashboard">
		<div class="container">
			<div class="dashboard-header">
				<h1>Find Blood Donors</h1>
				<p>Search for available blood donors in your area</p>
			</div>

			<div class="search-section">
				<div class="card">
					<h2>Search Filters</h2>
					<div class="search-form">
						<div class="form-row">
							<div class="form-group">
								<label class="form-label" for="searchBloodType">Blood Type Needed</label>
								<select id="searchBloodType" class="form-select">
									<option value="">All Blood Types</option>
									<option value="A+">A+</option>
									<option value="A-">A-</option>
									<option value="B+">B+</option>
									<option value="B-">B-</option>
									<option value="AB+">AB+</option>
									<option value="AB-">AB-</option>
									<option value="O+">O+</option>
									<option value="O-">O-</option>
								</select>
							</div>
							<div class="form-group">
								<label class="form-label" for="searchCity">City</label>
								<input type="text" id="searchCity" class="form-input" placeholder="Enter city">
							</div>
							<div class="form-group">
								<label class="form-label" for="searchStatus">Availability</label>
								<select id="searchStatus" class="form-select">
									<option value="">All Donors</option>
									<option value="Available">Available</option>
									<option value="Unavailable">Unavailable</option>
								</select>
							</div>
						</div>
						<button id="searchBtn" class="btn btn-primary">üîç Search Donors</button>
					</div>
				</div>
			</div>

			<div class="results-section">
				<div class="results-header">
					<h2>Available Donors</h2>
					<div class="results-count">
						<span id="donorCount">0</span> donors found
					</div>
				</div>
				
				<div id="donorsList" class="donors-grid">
					<!-- Donors will be populated here -->
				</div>

				<div id="noDonors" class="no-donors" style="display: none;">
					<div class="no-donors-content">
						<div class="no-donors-icon">ü©∏</div>
						<h3>No Donors Found</h3>
						<p>Try adjusting your search filters or check back later for new donors.</p>
						<a href="/donor-dashboard" class="btn btn-primary">Become a Donor</a>
					</div>
				</div>
			</div>

			<!-- Emergency Contact Section -->
			<div class="emergency-section">
				<div class="card emergency-card">
					<div class="emergency-content">
						<div class="emergency-icon">üö®</div>
						<div class="emergency-text">
							<h3>Emergency Blood Needed?</h3>
							<p>For urgent blood requirements, contact our 24/7 emergency helpline</p>
						</div>
						<div class="emergency-contact">
							<a href="tel:1-800-BLOOD-HELP" class="btn btn-primary">üìû Emergency Call</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>

	<Footer />
</Layout>

<style>
	.dashboard {
		padding: 2rem 0 4rem;
		min-height: 80vh;
	}

	.dashboard-header {
		text-align: center;
		margin-bottom: 3rem;
	}

	.dashboard-header h1 {
		font-size: 2.5rem;
		font-weight: 700;
		color: #1f2937;
		margin-bottom: 0.5rem;
	}

	.dashboard-header p {
		font-size: 1.1rem;
		color: #6b7280;
	}

	.search-section {
		margin-bottom: 3rem;
	}

	.search-section .card {
		padding: 2rem;
	}

	.search-section h2 {
		font-size: 1.5rem;
		font-weight: 600;
		color: #dc2626;
		margin-bottom: 1.5rem;
	}

	.search-form .form-row {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 1rem;
		margin-bottom: 1.5rem;
	}

	.results-section {
		margin-bottom: 3rem;
	}

	.results-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
	}

	.results-header h2 {
		font-size: 1.5rem;
		font-weight: 600;
		color: #1f2937;
	}

	.results-count {
		background: #dc2626;
		color: white;
		padding: 0.5rem 1rem;
		border-radius: 9999px;
		font-weight: 500;
	}

	.donors-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
		gap: 1.5rem;
	}

	.donor-card {
		background: white;
		border: 2px solid #e5e7eb;
		border-radius: 1rem;
		padding: 1.5rem;
		transition: all 0.3s ease;
	}

	.donor-card:hover {
		border-color: #dc2626;
		transform: translateY(-2px);
		box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
	}

	.donor-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		margin-bottom: 1rem;
	}

	.donor-info h3 {
		font-size: 1.25rem;
		font-weight: 600;
		color: #1f2937;
		margin-bottom: 0.25rem;
	}

	.donor-location {
		color: #6b7280;
		font-size: 0.875rem;
	}

	.donor-details {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 1rem;
		margin-bottom: 1.5rem;
	}

	.detail-item {
		display: flex;
		flex-direction: column;
	}

	.detail-label {
		font-size: 0.75rem;
		color: #6b7280;
		text-transform: uppercase;
		font-weight: 500;
		margin-bottom: 0.25rem;
	}

	.detail-value {
		font-weight: 600;
		color: #1f2937;
	}

	.donor-actions {
		display: flex;
		gap: 0.5rem;
	}

	.btn-small {
		padding: 0.5rem 1rem;
		font-size: 0.875rem;
		flex: 1;
	}

	.btn-outline {
		background: transparent;
		color: #dc2626;
		border: 1px solid #dc2626;
	}

	.btn-outline:hover {
		background: #dc2626;
		color: white;
	}

	.no-donors {
		text-align: center;
		padding: 4rem 2rem;
	}

	.no-donors-content {
		max-width: 400px;
		margin: 0 auto;
	}

	.no-donors-icon {
		font-size: 4rem;
		margin-bottom: 1rem;
	}

	.no-donors h3 {
		font-size: 1.5rem;
		font-weight: 600;
		color: #1f2937;
		margin-bottom: 0.5rem;
	}

	.no-donors p {
		color: #6b7280;
		margin-bottom: 2rem;
	}

	.emergency-section {
		margin-top: 3rem;
	}

	.emergency-card {
		background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
		border: 2px solid #fecaca;
	}

	.emergency-content {
		display: flex;
		align-items: center;
		gap: 2rem;
	}

	.emergency-icon {
		font-size: 3rem;
	}

	.emergency-text {
		flex: 1;
	}

	.emergency-text h3 {
		font-size: 1.25rem;
		font-weight: 600;
		color: #dc2626;
		margin-bottom: 0.5rem;
	}

	.emergency-text p {
		color: #6b7280;
	}

	@media (max-width: 768px) {
		.search-form .form-row {
			grid-template-columns: 1fr;
		}

		.results-header {
			flex-direction: column;
			gap: 1rem;
			text-align: center;
		}

		.donors-grid {
			grid-template-columns: 1fr;
		}

		.emergency-content {
			flex-direction: column;
			text-align: center;
			gap: 1rem;
		}
	}
</style>

<script>
	function loadDonors() {
		const donors = JSON.parse(localStorage.getItem('bloodDonors') || '[]');
		return donors;
	}

	function displayDonors(donors) {
		const donorsList = document.getElementById('donorsList');
		const donorCount = document.getElementById('donorCount');
		const noDonors = document.getElementById('noDonors');

		if (!donorsList || !donorCount || !noDonors) return;

		donorCount.textContent = donors.length;

		if (donors.length === 0) {
			donorsList.style.display = 'none';
			noDonors.style.display = 'block';
			return;
		}

		donorsList.style.display = 'grid';
		noDonors.style.display = 'none';

		donorsList.innerHTML = donors.map(donor => `
			<div class="donor-card">
				<div class="donor-header">
					<div class="donor-info">
						<h3>${donor.firstName} ${donor.lastName}</h3>
						<div class="donor-location">üìç ${donor.city}, ${donor.state}</div>
					</div>
					<div class="blood-type">${donor.bloodType}</div>
				</div>
				<div class="donor-details">
					<div class="detail-item">
						<span class="detail-label">Age</span>
						<span class="detail-value">${donor.age} years</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Gender</span>
						<span class="detail-value">${donor.gender}</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Status</span>
						<span class="detail-value">
							<span class="${donor.status === 'Available' ? 'status-available' : 'status-unavailable'}">
								${donor.status}
							</span>
						</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Last Donation</span>
						<span class="detail-value">${donor.lastDonation || 'Not specified'}</span>
					</div>
				</div>
				<div class="donor-actions">
					<button class="btn btn-primary btn-small" onclick="contactDonor('${donor.phone}', '${donor.firstName}')">
						üìû Contact
					</button>
					<button class="btn btn-outline btn-small" onclick="emailDonor('${donor.email}', '${donor.firstName}')">
						üìß Email
					</button>
				</div>
			</div>
		`).join('');
	}

	function filterDonors() {
		const allDonors = loadDonors();
		const bloodType = document.getElementById('searchBloodType')?.value || '';
		const city = document.getElementById('searchCity')?.value.toLowerCase() || '';
		const status = document.getElementById('searchStatus')?.value || '';

		const filteredDonors = allDonors.filter(donor => {
			const matchesBloodType = !bloodType || donor.bloodType === bloodType;
			const matchesCity = !city || donor.city.toLowerCase().includes(city);
			const matchesStatus = !status || donor.status === status;
			
			return matchesBloodType && matchesCity && matchesStatus;
		});

		displayDonors(filteredDonors);
	}

	function contactDonor(phone, name) {
		if (confirm(`Contact ${name} at ${phone}?`)) {
			window.open(`tel:${phone}`);
		}
	}

	function emailDonor(email, name) {
		const subject = encodeURIComponent('Blood Donation Request - BloodConnect');
		const body = encodeURIComponent(`Dear ${name},\n\nI hope this message finds you well. I am reaching out through BloodConnect regarding a blood donation request.\n\nWould you be available to donate blood? Please let me know your availability.\n\nThank you for your willingness to help save lives.\n\nBest regards`);
		window.open(`mailto:${email}?subject=${subject}&body=${body}`);
	}

	// Initialize page
	document.addEventListener('DOMContentLoaded', function() {
		// Load all donors initially
		const allDonors = loadDonors();
		displayDonors(allDonors);

		// Add search functionality
		document.getElementById('searchBtn')?.addEventListener('click', filterDonors);
		
		// Add real-time filtering
		['searchBloodType', 'searchCity', 'searchStatus'].forEach(id => {
			document.getElementById(id)?.addEventListener('change', filterDonors);
			document.getElementById(id)?.addEventListener('input', filterDonors);
		});
	});

	// Make functions global for onclick handlers
	window.contactDonor = contactDonor;
	window.emailDonor = emailDonor;
</script>